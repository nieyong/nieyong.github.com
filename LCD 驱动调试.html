<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css">
<title>LCD Çı¶¯µ÷ÊÔ</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
	<div id="header"> 
	    <div id="headerlogo">
		<h1><a href="index.html">NieNet çŸ¥è¯†åº“</a></h1>
		<p>Edit by Vimwiki--Powered by Github Pages</p>
	    </div>

	    <div id="headernav">
		<ul id="nav">
		    <li><a href="index.html">é¦–é¡µ</a></li>
		    <li><a href="Navigate.html">æœ¬ç«™å¯¼å›¾</a> </li>
		    <li><a href="AboutMe.html">å…³äº</a> </li>
		    <li><a href="http://nienet.com">è¿”å›NieNet</a></li>
		</ul>
	    </div>
	</div> 
    <div id="wrap">
	
<p>
ä¸ºä¸€å—æ–°çš„LCDå±ç¼–å†™äº†é©±åŠ¨ï¼Œç„¶åç¼–è¯‘è¿›å†…æ ¸ï¼Œä¸‹è½½åˆ°å¼€å‘æ¿ä¸Šï¼Œè¿™æ—¶å€™ï¼Œå±å¹•ä¹Ÿè®¸é™¤äº†èƒŒå…‰ï¼Œæ²¡æœ‰å…¶å®ƒä»»ä½•çš„æ˜¾ç¤ºï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆè¿›è¡Œè°ƒè¯•å‘¢ï¼Ÿä¸‹é¢æ˜¯å‡ ä¸ªæœ€åŸºæœ¬çš„é—®é¢˜ï¼š
</p>
<ul>
<li>
å¦‚ä½•ç¡®å®šLCDé©±åŠ¨åŠ è½½äº†å‘¢ï¼Ÿ

<li>
LCDé©±åŠ¨çš„åŸºæœ¬ä¿¡æ¯æ˜¯å¦æ­£ç¡®å‘¢ï¼Œå¦‚ä½•æ£€æŸ¥ï¼Ÿ

<li>
èƒ½å¦é€šè¿‡åº”ç”¨ç¨‹åºæ¥å¯¹LCDå±å¹•è¿›è¡Œæ§åˆ¶å‘¢ï¼Ÿè¿™é‡Œçš„FrameBufferçš„åº”ç”¨ç¨‹åºå¦‚ä½•ç¼–å†™å‘¢ï¼Ÿ

</ul>
<p>
ä¸‹é¢æ˜¯ä¸€äº›æˆ‘ç°åœ¨ç”¨åˆ°çš„åŠæ³•ï¼š
</p>

<h2 id="toc_0.1">å‘½ä»¤è¡ŒæŸ¥çœ‹FrameBufferçš„ä¿¡æ¯ </h2>
<pre>
# cat /proc/fb		//åœ¨/procç›®å½•ï¼ŒæŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­çš„å¸§ç¼“å†²è®¾å¤‡
0 jz-lcd
1 jz-slcd
# ls /dev/fb*		//æŸ¥çœ‹/devç›®å½•ä¸‹çš„ä¸åŒçš„å¸§ç¼“å†²è®¾å¤‡
/dev/fb0  /dev/fb1
</pre>
<p>
å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªå¸§ç¼“å†²è®¾å¤‡ã€‚å…¶ä¸­ç¬¬0ä¸ªå¸§ç¼“å­˜è®¾å¤‡/dev/fb0ï¼Œå¯¹åº”çš„æ˜¯LCDæ§åˆ¶å™¨ï¼ˆjz-lcdï¼‰çš„é©±åŠ¨ï¼Œè€Œç¬¬1ä¸ªå¸§ç¼“å­˜è®¾å¤‡/dev/fb1ï¼Œå°±æ˜¯æ™ºèƒ½LCDæ§åˆ¶å™¨ï¼ˆjz-slcdï¼‰çš„é©±åŠ¨ã€‚å¯ä»¥åœ¨./drivers/video/ç›®å½•ä¸‹é¢çš„é©±åŠ¨æ–‡ä»¶ï¼ˆè¿™é‡Œæ˜¯jzlcd.cæ–‡ä»¶å’Œjz4740_slcd.cæ–‡ä»¶ï¼‰ä¸­çœ‹åˆ°/proc/fbä¸­å‘½åå’Œæ³¨å†Œã€‚
</p>
<pre>
static struct lcd_cfb_info * jzfb_alloc_fb_info(void)
{
    â€¦â€¦
    strcpy(cfb-&gt;fb.fix.id, "jz-lcd");	//è¿™é‡Œçš„å­—ç¬¦ä¸²"jz-lcd"å°±æ˜¯åœ¨/proc/fbä¸­çœ‹åˆ°çš„æ‰“å°ä¿¡æ¯ï¼Œä¿®æ”¹è¿™é‡Œå¯ä»¥åœ¨/proc/fbä¸­çœ‹åˆ°ç›¸åº”çš„æ”¹åŠ¨
    â€¦â€¦
}


static int __init jzfb_init(void)
{
    â€¦â€¦
    err = register_framebuffer(&amp;cfb-&gt;fb);
    if (err &lt; 0) {
	    dprintk("jzfb_init(): register framebuffer err.\n");
	    goto failed;
    }
    â€¦â€¦
ï½
</pre>
<p>
register_framebuffer()å‡½æ•°å°±æ˜¯å°†LCDæ§åˆ¶å™¨ï¼ˆjz-lcdï¼‰çš„é©±åŠ¨æ³¨å†Œåˆ°frame bufferä¸­ï¼Œè¿™æ ·æ‰æœ‰æˆ‘ä»¬çœ‹åˆ°çš„/proc/fbä¸­çš„å¸§ç¼“å­˜è®¾å¤‡0 jz-lcdä»¥åŠ/dev/fb0è®¾å¤‡æè¿°ç¬¦ã€‚åŒç†ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åŒæ—¶å°†æ™ºèƒ½LCDæ§åˆ¶å™¨ï¼ˆjz-slcdï¼‰çš„é©±åŠ¨æ³¨å†Œåˆ°frame bufferä¸­ã€‚
</p>

<p>
å¯ä»¥çœ‹åˆ°ï¼Œframe bufferä½œä¸ºé©±åŠ¨ç¨‹åºï¼Œæ˜¯å„ç§ä¸åŒçš„æ˜¾ç¤ºè®¾å¤‡å¯¹OSï¼Œåº”ç”¨å±‚çš„ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œä¸€ä¸ªé©±åŠ¨æ¥å£ã€‚
</p>

<p>
åœ¨åˆšå¼€å§‹çš„æ—¶å€™ï¼Œç”±äºæ²¡æœ‰åœ¨.configæ–‡ä»¶ä¸­å°†jz-lcdé©±åŠ¨é€‰é¡¹å»æ‰ï¼Œæ‰€ä»¥åŠ è½½äº†ä¸¤ä¸ªå¸§ç¼“å†²è®¾å¤‡ï¼Œå¦‚ä¸Šé¢æ‰€ç¤ºã€‚
</p>

<h2 id="toc_0.2">å‘½ä»¤è¡ŒæŸ¥çœ‹FrameBufferçš„ä¸­æ–­ä¿¡æ¯ </h2>
<p>
æŸ¥çœ‹åˆ°å¸§è®¾å¤‡ä¹‹åï¼Œé‚£ä¹ˆå¸§è®¾å¤‡æœ‰æ²¡æœ‰å·¥ä½œå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡äº§çœ‹ä¸­æ–­çš„åŠæ³•ï¼Œå¤§æ¦‚çš„çœ‹åˆ°å¸§è®¾å¤‡æ˜¯å¦å·¥ä½œã€‚
</p>
<pre>
# cat /proc/interrupts
           CPU0
  3:          2            INTC  ohci_hcd:usb1
  9:       5758            INTC  serial
 14:          0            INTC  MMC/SD
 15:          0            INTC  rtc
 17:          0            INTC  cim
 23:      73137            INTC  jz-timerirq
 30:          0            INTC  lcd
 32:          0             DMA  auto
 33:          0             DMA  MMC Rx
 34:          0             DMA  MMC Tx
 35:          0             DMA  audio adc
 36:          0             DMA  audio dac
150:          0            GPIO  udc_pnp
158:          0            GPIO  MMC card detect
173:          0            GPIO  poweroff

ERR:          0
</pre>
<p>
é€šè¿‡æ‰“å°/proc/interruptsçš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°30å·ä¸­æ–­ï¼Œå¯¹åº”ä¸Šé¢çš„jz-lcdé©±åŠ¨ï¼Œè€Œ32å·ä¸­æ–­ï¼Œæ˜¯DMAä¸­æ–­ï¼Œåå­—ä¸ºautoï¼Œè¿™å…¶å®å¯¹åº”jz-slcdçš„ä¸­æ–­ï¼Œjz4740_slcd.cæ–‡ä»¶ä¸­æœ‰ä¸‹é¢çš„ä»£ç ä¸ºè¯ï¼š
</p>
<pre>
static int slcd_dma_init(void)
{
	/* Request DMA channel and setup irq handler */
	dma_chan = jz_request_dma(DMA_ID_AUTO, "auto", slcd_dma_irq, 0, NULL);
	if (dma_chan &lt; 0) {
		printk("Request DMA Failed\n");
		return -1;
	}
	printk("DMA channel %d is requested by SLCD!\n", dma_chan);
	â€¦â€¦
}
</pre>
<p>
å¯ä»¥çœ‹åˆ°ï¼Œè¿™é©±åŠ¨ä¸­ï¼Œé€šè¿‡jz_request_dma()å‡½æ•°è¯·æ±‚å¯ä¸€ä¸ªDMAé€šé“ï¼Œåå­—ä¸ºautoï¼Œå¹¶ä¸”æ³¨å†Œäº†DMAä¸­æ–­å‡½æ•°slcd_dma_irq()ã€‚é€šè¿‡æŸ¥çœ‹å†…æ ¸å¯åŠ¨ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥éªŒè¯è¿™ä¸€ç‚¹ã€‚
</p>
<pre>
# cat /proc/
â€¦â€¦
DMA channel 0 is requested by SLCD!
â€¦â€¦
</pre>

<p>
å…¶ä¸­ï¼Œcat /proc/interruptsçš„è¾“å‡ºç¬¬äºŒåˆ—è¡¨ç¤ºè¿›å…¥è¿™ä¸ªä¸­æ–­çš„æ¬¡æ•°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿›å…¥jz-lcdå’Œautoçš„ä¸­æ–­æ¬¡æ•°ä¸º0æ¬¡ï¼Œä¹Ÿå°±æ˜¯ä»æ²¡æœ‰è¿›å…¥è¿‡ä¸­æ–­ã€‚æ²¡æœ‰è¿›å…¥è¿‡ä¸­æ–­ï¼Œå°±æ²¡æœ‰DMAå°†å›¾åƒä»å†…å­˜å†™å…¥æ˜¾å­˜ï¼ˆGRAMï¼‰çš„è¿‡ç¨‹ï¼ŒLCDä¸Šæ²¡æœ‰å›¾åƒæ˜¾ç¤ºï¼Œä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚
</p>

<h2 id="toc_0.3">æŸ¥çœ‹å†…æ ¸å¯åŠ¨ä¿¡æ¯</h2>
<p>
æŸ¥çœ‹å†…æ ¸å¯åŠ¨æ—¶çš„è¾“å‡ºä¿¡æ¯æ˜¯æœ€ç›´æ¥ï¼Œæœ‰æ•ˆçš„è°ƒè¯•æ–¹å¼ã€‚å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸‹ä½¿ç”¨klogå‘½ä»¤ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ¥ä¸²å£è·å¾—å†…æ ¸å¯åŠ¨ä¿¡æ¯ã€‚ä¸‹é¢å°±ä¸‹é¢çš„è¾“å‡ºåšå‡ºåˆ†æï¼š
</p>
<pre>

fb_alloc_cmap,fb.cmap.len:256....
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:0,RGBt:(0,0,0,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:1,RGBt:(0,0,43690,65535)
â€¦â€¦		//çœç•¥äº†regno:2~regno:253
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:254,RGBt:(44767,65503,65519,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:255,RGBt:(65535,65535,65535,65535)
jzfb_set_var: after fb_set_cmap...
slcd_hw_init---------jzfb.w:240jzfb.h:320,jzfb.bpp:16
in order to init slcd SLCD_CFG=0x4400
SLCDC: PixClock:16000000 LcdClock:28000000
SLCD_CFG=0x4400
jzfb_set_pardbg::drivers/video/jz4740_slcd.c,LINE(460): var.yoffset: 0
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:0,RGBt:(0,0,0,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:1,RGBt:(0,0,43690,65535)
â€¦â€¦		//çœç•¥äº†regno:2~regno:13
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:14,RGBt:(65535,65535,21845,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:15,RGBt:(65535,65535,65535,65535)
Console: switching to colour frame buffer device 30x40
dbg::drivers/video/jz4740_slcd.c,LINE(460): var.yoffset: 0
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:0,RGBt:(0,0,0,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:1,RGBt:(0,0,43690,65535)
â€¦â€¦		//çœç•¥äº†regno:2~regno:13
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:14,RGBt:(65535,65535,21845,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:15,RGBt:(65535,65535,65535,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:0,RGBt:(0,0,0,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:1,RGBt:(0,0,43690,65535)
â€¦â€¦		//çœç•¥äº†regno:2~regno:13
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:14,RGBt:(65535,65535,21845,65535)
dbg::drivers/video/jz4740_slcd.c,LINE(221): regno:15,RGBt:(65535,65535,65535,65535)
fb0: jz-ny-slcd frame buffer device, using 256K of video memory
DMA channel 0 is requested by SLCD!
</pre>
<p>
ä¹‹æ‰€ä»¥æœ‰ä¸Šé¢è¿™ä¹ˆå¤šçš„è¾“å‡ºä¿¡æ¯ï¼Œæ˜¯å› ä¸ºé©±åŠ¨æ–‡ä»¶ä¸­åŸæ¥å®šä¹‰çš„è°ƒè¯•å®è¢«æ‰“å¼€äº†ï¼Œå¹¶ä¸”ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ä½ è‡ªå·±è§‰å¾—æœ‰ç–‘é—®ï¼Œéœ€è¦æ‰“å°çš„åœ°æ–¹åŠ å…¥è¾“å‡ºä¿¡æ¯ã€‚
æ‰“å¼€è°ƒè¯•å®çš„åŠæ³•ï¼š
ä¾‹å¦‚åœ¨æ–‡ä»¶jz4740_slcd.cä¸­ï¼Œ
</p>
<pre>
//#undef DEBUG		//å¦‚æœä¸æƒ³æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨è¿™ä¸€å¥
#define DEBUG		//å¦‚æœæƒ³æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œä½¿ç”¨è¿™ä¸€å¥
#ifdef DEBUG
#define dprintk(x...)	printk(x)
#else
#define dprintk(x...)
#endif
</pre>
<p>
åŸæ¥#define DEBUGæ˜¯è¢«æ³¨é‡Šæ‰çš„ï¼Œç°åœ¨å»æ‰æ³¨é‡Šï¼Œç„¶åå°†#undef DEBUGæ³¨é‡Šæ‰ã€‚è¿™æ ·ï¼Œä¸‹é¢æ–‡ä»¶ä¸­ä½¿ç”¨åˆ°çš„dprintk()å‡½æ•°å°±ä¼šä½¿ç”¨printk()å‡½æ•°åšå†…æ ¸çš„è¾“å‡ºç­”åº”ã€‚
</p>

<p>
è‡³äºæ·»åŠ ç­”åº”æ“ä½œï¼Œé‚£ä¹ˆå°±ä½¿ç”¨dprintk()å‡½æ•°å°±å¯ä»¥äº†ï¼Œç”¨æ³•å’Œprintf()ç±»ä¼¼ã€‚
</p>

	</div>
	<div id="footer">
		<p id="legal">Copyright &copy; 2012 &middot;<a href="http://nienet.com">NIENET</a>. All Rights Reserved.</p>
	</div>
</body>
</html>
